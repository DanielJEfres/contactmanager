# Database Queries

This document defines the standard SQL queries required for the API. Please adhere to the binding instructions to prevent errors while querying the database.

This documentation was partially generated by Gemini Pro v3

## 1. Search Contacts

### Purpose
Select contact records from Contacts based on UserID, and any of these other columns: Firstname, LastName, Phone, and Email
This query takes 1 search term. The search term can be any of the following:
   - "firstName" + " " + "lastName"
   - Phone number
   - Email address

### Query
```sql
SELECT ID, FirstName, LastName, Phone, Email, DateCreated
FROM Contacts 
WHERE UserID = :id
    AND (
        CONCAT_WS(' ', FirstName, LastName) LIKE :search 
        OR Phone LIKE :search 
        OR Email LIKE :search 
    )
ORDER BY FirstName ASC
LIMIT :limit OFFSET :offset;
```

### Implementation Notes

**:id (String)**
- Description: The UUID of the logged-in user.
- Binding: Bind as standard string.

**:search (String)**
- Description: The user's input (once cleaned).
- Binding: Wrap in wildcards (e.g., "%John Doe%") to get substring matches. If you need to get every record, use "%%".

**A note on pagination**
- If you don't want to paginate the result of this query, simply remove the LIMIT ... OFFSET ... line from the SQL string before preparing the statement.

**:limit (Integer)**
- Description: Records to return per page (e.g., 10).
- Binding: MUST bind as PDO::PARAM_INT.

**:offset (Integer)**
- Description: Number of pages of records to skip
- Binding: MUST bind as PDO::PARAM_INT.
- Formula: (pageNum - 1) * limit.

## 3. Add Contact

### Purpose
Creates a new contact record linked to the logged-in user.

### Query
```sql
INSERT INTO 
    Contacts (
        UserID, 
        FirstName, 
        LastName, 
        Phone, 
        Email, 
        DateCreated
    )
VALUES 
    (
        :id, 
        :firstName, 
        :lastName, 
        :phone, 
        :email, 
        NOW()
    );
```

### Implementation Notes
***Validation Rule:***
-The API must reject the request with a 400 Bad Request error if the payload contains empty values for all four contact fields (FirstName, LastName, Phone, Email). A contact must contain at least one piece of information.

**:uid (String)**
- Description: The UUID of the logged-in user.

**:firstName (String)**
- Description: First Name. Bind NULL if empty.

**:lastName (String)**
- Description: Last Name. Bind NULL if empty.

**:phone (String)**
- Description: Phone number. Bind NULL if empty.

**:email (String)**
- Description: Email address. Bind NULL if empty.

## 4. Update Contact

### Purpose
Updates an existing contact's details.
**Note:** This is an "Overwrite" operation. The API must send new values for changed fields and *existing* values for unchanged fields. In other words, don't bind NULL to a field unless you are clearing it.

### Query
```sql
UPDATE Contacts
SET FirstName = :firstName,
    LastName = :lastName,
    Phone = :phone,
    Email = :email
WHERE ID = :cid 
    AND UserID = :uid;
```

### Implementation Notes
**:firstName (String)**
- Description: The new (or existing) First Name. Bind NULL if clearing the field.

**:lastName (String)**
- Description: The new (or existing) Last Name. Bind NULL if clearing the field.

**:phone (String)**
- Description: The new (or existing) Phone. Bind NULL if clearing the field.

**:email (String)**
- Description: The new (or existing) Email. Bind NULL if clearing the field.

**:cid (Integer)**
- Description: The unique ID of the contact to update.

**:uid (String)**
- Description: The UUID of the logged-in user. Required for security.

## 5. Delete Contact

### Purpose
Permanently removes a specific contact record.

### Query
```sql
DELETE FROM Contacts
WHERE 
    ID = :id 
    AND UserID = :uid;
```

### Implementation notes
**:id (Integer)**
- Description: The unique ID of the contact to delete.

**:uid (String)**
- Description: The UUID of the logged-in user. Required for security.

## 6. Delete User

### Purpose
Permanently deletes a user account.
**Note**: Because `ON DELETE CASCADE` is enabled in the database schema, running this single query will automatically and instantly delete all contacts associated with this user.

### Query
```sql
DELETE FROM Users
WHERE 
    ID = :uid;
```

### Implementation Notes
**:uid (String)**
- Description: The UUID of the user to delete.

## 7. Get Single Contact

### Purpose
Retrieves the details of a specific contact. 

### Query
```sql
SELECT 
    ID, 
    FirstName, 
    LastName, 
    Phone, 
    Email, 
    DateCreated
FROM 
    Contacts
WHERE 
    ID = :id 
    AND UserID = :uid;
```

### Implementation Notes
**:id (Integer/String)**
- Description: The unique ID of the contact to retrieve.

**:uid (String)**
- Description: The UUID of the logged-in user.

## 8. Update User (Profile/Credentials)

### Purpose
Updates a user's login credentials (Username, Password, and Salt).
**Note:** This is an "Overwrite" operation. To change just the Username, the API must still re-send the existing Password.

### Query
```sql
UPDATE Users
SET 
    Username = :username,
    Password = :password,
    Salt = :salt
WHERE 
    ID = :uid;
```

### Implementation Notes
**Uniqueness:** 
- If the new :username is already taken by another user, the database will throw a Duplicate Key Error (assuming the UNIQUE constraint is set on the Username column). The API must catch this error and show a nice message ("That username is already taken") to the user.

**:username (String)**
- Description: The new (or existing) Username.

**:password (String)**
- Description: The Hashed password string. Never bind plain text here.

**:salt (String)**
- Description: The random salt string used for hashing.
- Note: The Users table does not have a column for storing a salt. If using PHP standard password_hash(), this is unnecessary.

**:uid (String)**
- Description: The UUID of the user to update.


## 9. Register User (Create Account)

### Purpose
Creates a new user account.

### Query
```sql
INSERT INTO 
    Users (Username, Password)
VALUES 
    (:username, :password);
```

### Implementation Notes

**Duplicate Check:** 
- If this Username already exists, the database will throw a Duplicate Entry Error (Error 1062). The API should catch this specific error code and return a friendly "Username already taken" message to the user.

**Security Warning:** 
- Never insert a plain-text password here. The API must hash it (e.g., password_hash()) before sending it to the database.

**:username (String)**
- Description: The desired username.

**:password (String)**
- Description: The Hashed password.
